<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>King -ultimate edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, orientation=landscape"/>
<style>
  /* --- INTERFACCIA ORIGINALE (NON TOCCATA) --- */
  * { touch-action: none; -webkit-user-select: none; box-sizing: border-box; }
  body { margin: 0; overflow: hidden; background: #020005; font-family: sans-serif; }
  #stars-bg { position: fixed; inset: 0; background: radial-gradient(circle, #1a0033, #020005); z-index: -1; }
  .overlay-screen { position: fixed; inset: 0; background: rgba(5,0,15,0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 500; }
  .hide { display: none !important; }
  .menu-btn { background: #b71c1c; color: white; border: 2px solid #ff0000; padding: 15px; margin: 10px; width: 250px; border-radius: 12px; cursor: pointer; font-weight: bold; }
  .pow-item { border: 1px solid #ff0000; padding: 15px; margin: 5px; border-radius: 8px; cursor: pointer; width: 200px; text-align: center; color: white; }
  .pow-item.active { border-color: #00e676; background: rgba(0,230,118,0.2); }
  #game-container { position: relative; width: 100%; height: 100%; display: none; }
  #world { position: absolute; width: 5000px; height: 100%; }
  
  /* FIX PERSONAGGI: ID UNICI PER EVITARE INVERSIONI */
  #player { position: absolute; width: 42px; height: 58px; background: #ff0000; border: 3px solid #fff; z-index: 10; }
  #player2 { position: absolute; width: 42px; height: 58px; background: #0044ff; border: 3px solid #fff; z-index: 9; display: none; }
  
  #sword { position: absolute; width: 50px; height: 50px; display: none; font-size: 35px; top: -10px; left: 25px; transform-origin: left center; }
  .sword-anim { display: block !important; animation: slash 0.2s ease-out; }
  @keyframes slash { 0% { transform: rotate(-60deg); } 100% { transform: rotate(60deg); } }
  .platform { position: absolute; background: #330000; border-top: 4px solid #ff0000; }
  .controls { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; pointer-events: none; z-index: 1000; }
  .joystick-area { width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: auto; }
  #knob { position: absolute; width: 50px; height: 50px; background: #ff0000; border-radius: 50%; top: 35px; left: 35px; pointer-events: none; }
  .btn-group { display: flex; gap: 20px; pointer-events: auto; }
  .action-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; font-size: 2rem; display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body>

<div id="stars-bg"></div>

<div id="main-menu" class="overlay-screen">
  <h1 style="color:red; font-size: 3rem;">KING</h1>
  <button class="menu-btn" onclick="startSingle()">GIOCATORE SINGOLO</button>
  <button class="menu-btn" onclick="open1v1()">SCONTRO 1V1</button>
</div>

<div id="powerup-menu" class="overlay-screen hide">
  <h2 style="color:white;">SCEGLI POTERE</h2>
  <div class="pow-item active" onclick="selectSkill(this, 'speed')">VELOCITÀ</div>
  <div class="pow-item" onclick="selectSkill(this, 'power')">FORZA</div>
  <div class="pow-item" onclick="selectSkill(this, 'jump')">SUPER SALTO</div>
  <div class="pow-item" onclick="selectSkill(this, 'defense')">DIFESA</div>
  <button class="menu-btn" onclick="start1v1()">INIZIA BATTAGLIA</button>
</div>

<div id="game-container">
  <div id="world">
    <div id="player"><div id="sword">⚔️</div></div>
    <div id="player2"></div>
  </div>
  <div class="controls">
    <div class="joystick-area" id="joyArea"><div id="knob"></div></div>
    <div class="btn-group">
      <button class="action-btn" id="btnAtk">⚔️</button>
      <button class="action-btn" id="btnJmp">⬆️</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = (typeof io !== 'undefined') ? io() : null;
let state = 'MENU', px=100, py=100, vx=0, vy=0, health=5;
let moveDir = 0, onGround = false, holdingJump = false, isAttacking = false;
let is1v1 = false, activeSkill = 'speed';
const keys = {};

// --- SISTEMA INPUT (TASTIERA + GAMEPAD) ---
window.onkeydown = (e) => keys[e.code] = true;
window.onkeyup = (e) => keys[e.code] = false;

function handleGamepad() {
  const gamepads = navigator.getGamepads();
  if (!gamepads[0]) return;
  const gp = gamepads[0];
  
  // Movimento Analogico o D-pad
  if (gp.axes[0] < -0.2) moveDir = -1;
  else if (gp.axes[0] > 0.2) moveDir = 1;
  
  // Salto (Pulsante A o X)
  if (gp.buttons[0].pressed && onGround) jump();
  // Attacco (Pulsante X o Quadrato)
  if (gp.buttons[2].pressed) attack();
}

// --- LOGICA POTERI ---
function getStats() {
  let s = { spd: 8, jmp: -17, rng: 75, def: 1 };
  if(activeSkill === 'speed') s.spd = 14;
  if(activeSkill === 'jump') s.jmp = -23;
  if(activeSkill === 'power') s.rng = 110;
  if(activeSkill === 'defense') s.def = 0.5;
  return s;
}

function selectSkill(el, skill) {
  document.querySelectorAll('.pow-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  activeSkill = skill;
}

function jump() {
  const stats = getStats();
  if(onGround) { vy = stats.jmp; onGround = false; holdingJump = true; }
}

function attack() {
  if(isAttacking) return;
  isAttacking = true;
  if(socket && is1v1) socket.emit('attack', {x: px, y: py, skill: activeSkill});
  document.getElementById('sword').classList.add('sword-anim');
  setTimeout(() => { document.getElementById('sword').classList.remove('sword-anim'); isAttacking = false; }, 200);
}

// --- FIX CONTROLLI MOBILE (ANTI-VOLO) ---
function initControls() {
  const btnJmp = document.getElementById('btnJmp');
  const btnAtk = document.getElementById('btnAtk');
  
  btnJmp.onpointerdown = (e) => { e.preventDefault(); jump(); };
  btnJmp.onpointerup = (e) => { e.preventDefault(); holdingJump = false; };
  
  btnAtk.onpointerdown = (e) => { e.preventDefault(); attack(); };

  const joyArea = document.getElementById('joyArea');
  joyArea.onpointermove = (e) => {
    if(e.buttons > 0) {
      let rect = joyArea.getBoundingClientRect();
      let x = e.clientX - (rect.left + rect.width/2);
      moveDir = Math.max(-1, Math.min(1, x/40));
      document.getElementById('knob').style.left = (35 + moveDir*30) + 'px';
    }
  };
  joyArea.onpointerup = () => { moveDir = 0; document.getElementById('knob').style.left = '35px'; };
}

// --- MULTIPLAYER (FIX RENDER & INVERSIONE ID) ---
if (socket) {
  socket.on('enemyMove', (data) => {
    const p2 = document.getElementById('player2');
    p2.style.display = 'block';
    p2.style.left = data.x + 'px';
    p2.style.top = data.y + 'px';
  });

  socket.on('enemyAttack', (data) => {
    let dist = Math.sqrt((px - data.x)**2 + (py - data.y)**2);
    let enemyRange = (data.skill === 'power') ? 110 : 75;
    if(dist < enemyRange) {
      let myStats = getStats();
      health -= myStats.def;
      document.getElementById('player').style.filter = "brightness(2) red";
      setTimeout(() => document.getElementById('player').style.filter = "none", 100);
      if(health <= 0) location.reload();
    }
  });
}

function update() {
  if (state === 'PLAYING') {
    handleGamepad();
    
    // Tastiera
    if(keys['ArrowLeft'] || keys['KeyA']) moveDir = -1;
    else if(keys['ArrowRight'] || keys['KeyD']) moveDir = 1;
    else if(!('ontouchstart' in window) && moveDir !== 0) moveDir = 0;
    if((keys['Space'] || keys['ArrowUp']) && onGround) jump();

    const stats = getStats();
    vx = moveDir * stats.spd;
    vy += (vy < 0 && (holdingJump || keys['Space'])) ? 0.4 : 0.9;
    px += vx; py += vy;

    if(socket && is1v1) socket.emit('move', {x: px, y: py});

    // Collisione Suolo
    onGround = false;
    const groundY = window.innerHeight - 100;
    if(py > groundY - 58) { py = groundY - 58; vy = 0; onGround = true; }

    // Camera e Render (Player Locale Rosso)
    document.getElementById('world').style.transform = `translateX(${-px + (window.innerWidth / 3)}px)`;
    const pEl = document.getElementById('player');
    pEl.style.left = px + 'px'; pEl.style.top = py + 'px';
    if(moveDir !== 0) pEl.style.transform = (moveDir > 0) ? 'scaleX(1)' : 'scaleX(-1)';
  }
  requestAnimationFrame(update);
}

// --- MENU ---
function open1v1() {
  let key = prompt("Codice Stanza:");
  if(key && socket) {
    socket.emit('joinRoom', key);
    document.getElementById('main-menu').classList.add('hide');
    document.getElementById('powerup-menu').classList.remove('hide');
  }
}
function start1v1() { is1v1 = true; startGame(); }
function startSingle() { is1v1 = false; startGame(); }

function startGame() {
  state = 'PLAYING';
  document.getElementById('main-menu').classList.add('hide');
  document.getElementById('powerup-menu').classList.add('hide');
  document.getElementById('game-container').style.display = 'block';
  const plat = document.createElement('div');
  plat.className = 'platform';
  plat.style.cssText = `width: 5000px; height: 100px; left: 0; top: ${window.innerHeight-100}px;`;
  document.getElementById('world').appendChild(plat);
  initControls();
}
update();
</script>
</body>
</html>
